---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-oidc-config
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: ClusterSecretStore
  target:
    name: argocd-secret
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        # Individual secret keys
        oidc.azure.clientSecret: "{{ .clientSecret }}"
        oidc.azure.clientId: "{{ .clientId }}"
        oidc.azure.tenantId: "{{ .tenantId }}"
        oidc.azure.adminGroupId: "{{ .adminGroupId }}"
        # Full OIDC config with templated values
        oidc.config: |
          name: Azure
          issuer: https://login.microsoftonline.com/{{ .tenantId }}/v2.0
          clientID: {{ .clientId }}
          clientSecret: $oidc.azure.clientSecret
          requestedScopes:
            - openid
            - profile
            - email
            - https://graph.microsoft.com/User.Read
            - https://graph.microsoft.com/Group.Read.All
          requestedIDTokenClaims:
            groups:
              essential: true
  data:
    - secretKey: clientSecret
      remoteRef:
        key: argocd-oidc-client-secret
    - secretKey: clientId
      remoteRef:
        key: argocd-oidc-client-id
    - secretKey: tenantId
      remoteRef:
        key: argocd-oidc-tenant-id
    - secretKey: adminGroupId
      remoteRef:
        key: argocd-oidc-admin-group-id
