apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
  labels:
    app.kubernetes.io/name: authentik
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
data:
  entra-id.yaml: |
    version: 1
    metadata:
      name: Entra ID OAuth Source
      labels:
        blueprints.goauthentik.io/description: "Microsoft Entra ID OIDC authentication source"
    entries:
      # 1. Create property mapping to extract user info from Entra ID
      - model: authentik_sources_oauth.oauthsourcepropertymapping
        id: entra-id-user-mapping
        identifiers:
          name: "Entra ID - User Mapping"
        attrs:
          expression: |
            # Extract user info from Entra ID OIDC response
            email = info.get("preferred_username") or info.get("email") or info.get("upn")

            if not email:
                email = info.get("sub", "") + "@torsteinbo.net"

            # Extract username (part before @)
            username = email.split("@")[0] if "@" in email else email

            return {
                "email": email,
                "username": username,
                "name": info.get("name") or info.get("displayName") or username,
                "type": "internal",
            }

      # 2. Create the OAuth Source
      - model: authentik_sources_oauth.oauthsource
        id: entra-id-source
        identifiers:
          slug: entra-id
        attrs:
          name: Microsoft Entra ID
          enabled: true
          authentication_flow: !Find [authentik_flows.flow, [slug, default-source-authentication]]
          enrollment_flow: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
          user_matching_mode: email_link
          provider_type: openidconnect
          consumer_key: !Env ENTRA_CLIENT_ID
          consumer_secret: !Env ENTRA_CLIENT_SECRET
          authorization_url: !Format ["https://login.microsoftonline.com/%s/oauth2/v2.0/authorize", !Env ENTRA_TENANT_ID]
          access_token_url: !Format ["https://login.microsoftonline.com/%s/oauth2/v2.0/token", !Env ENTRA_TENANT_ID]
          profile_url: https://graph.microsoft.com/oidc/userinfo
          oidc_well_known_url: !Format ["https://login.microsoftonline.com/%s/v2.0/.well-known/openid-configuration", !Env ENTRA_TENANT_ID]
          oidc_jwks_url: !Format ["https://login.microsoftonline.com/%s/discovery/v2.0/keys", !Env ENTRA_TENANT_ID]
          additional_scopes: "openid profile email"
          user_property_mappings:
            - !KeyOf entra-id-user-mapping

      # 3. Update default identification stage to include the OAuth source
      - model: authentik_stages_identification.identificationstage
        identifiers:
          name: default-authentication-identification
        attrs:
          user_fields:
            - email
            - username
          sources:
            - !KeyOf entra-id-source
          show_source_labels: true
          show_matched_user: true

  terraform-service-account.yaml: |
    version: 1
    metadata:
      name: Terraform Service Account
      labels:
        blueprints.goauthentik.io/description: "Service account for Terraform automation"
    entries:
      # 1. Create a service account user for Terraform
      - model: authentik_core.user
        id: terraform-service-account
        identifiers:
          username: terraform-automation
        attrs:
          name: "Terraform Automation"
          email: "terraform@torsteinbo.net"
          is_active: true
          type: service_account
          path: "goauthentik.io/service-accounts"

      # 2. Add service account to superuser group for full API access
      - model: authentik_core.group
        identifiers:
          name: authentik Admins
        attrs:
          users:
            - !Find [authentik_core.user, [username, akadmin]]
            - !KeyOf terraform-service-account

      # 3. Create an API token with known key value from environment
      # This allows Terraform to use the same token value from Key Vault
      - model: authentik_core.token
        id: terraform-api-token
        identifiers:
          identifier: terraform-api-token
        attrs:
          key: !Env TERRAFORM_API_TOKEN
          user: !KeyOf terraform-service-account
          intent: api
          expiring: false
          description: "API token for Terraform provider authentication"
